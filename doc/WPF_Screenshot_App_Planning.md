# WPF 截屏软件开发规划

## 项目概述
- **项目名称**：WPF 截屏工具
- **目标平台**：Windows 10/11，.NET 6 或更高版本，WPF
- **主要功能**：系统托盘常驻、全屏蒙版截图、截图后浮动工具栏（固定/编辑/取消/保存）、固定截图便签、调用系统画图程序、剪贴板保存逻辑。
- **非目标**：跨平台支持、视频录制、OCR 处理等拓展功能。

## 角色与资源
- **角色**：1 名 WPF/C# 工程师（可兼任 QA）。
- **外部依赖**：
  - Windows API（全局热键注册、蒙版窗口、托盘交互）。
  - `System.Windows.Forms`（托盘图标支持）。
  - Windows 内置画图程序 `mspaint.exe`。

## 技术栈与项目结构
- **技术栈**：C#, .NET 6 (或 7), WPF, MVVM 轻量架构。
- **项目结构（建议）**：
  - `App.xaml` / `App.xaml.cs`：应用入口、托盘初始化。
  - `Services/HotkeyService.cs`：注册全局热键、处理组合键触发。
  - `Services/ScreenshotService.cs`：截图流程控制，包含蒙版显示、区域选择。
  - `Services/ClipboardService.cs`：保存截图至内存与导出。
  - `Services/StickyImageService.cs`：固定截图便签管理。
  - `ViewModels`：托盘菜单、工具栏交互。
  - `Views/OverlayWindow.xaml`：蒙版与选区 UI。
  - `Views/FloatingToolbar.xaml`：截图工具栏。
  - `Models/ScreenshotResult.cs`：封装截图数据和状态。
  - `Interop`：Win32 P/Invoke（热键、窗口样式、鼠标捕获等）。

## 里程碑划分

### 里程碑 1：项目初始化与基础托盘逻辑
**目标**：搭建项目基础结构，确保应用可后台运行。
- 建立 WPF 项目，配置 .NET 目标框架。
- 实现启动最小化并隐藏主窗口。
- 实现托盘图标、右键菜单（退出等基础项）。
- 注册全局热键（Ctrl+Alt+End），触发占位事件。
- 编写基础日志（可选）。
- **交付**：运行后仅有托盘图标，按热键有调试输出。
- **风险**：全局热键冲突。解决方案：注册失败给出提示并允许用户配置。

### 里程碑 2：全屏蒙版与矩形选区
**目标**：实现截图核心交互。
- 设计全屏透明窗口 `OverlayWindow`，支持全屏覆盖显示蒙版。
- 监听鼠标按下、拖拽、抬起事件，绘制矩形选区（使用 `Canvas` 或 Adorner）。
- 处理 `Esc` 热键取消截图，恢复桌面。
- 鼠标释放后计算选区坐标，裁剪屏幕图像（`System.Drawing` 或 `D3DImage`）。
- **交付**：热键触发蒙版，支持选区，Esc 取消。
- **风险**：多显示器坐标映射。解决：使用 `SystemParameters.VirtualScreenLeft/Top/Width/Height` 获取虚拟屏幕。

### 里程碑 3：浮动工具栏与动作逻辑
**目标**：截图后工具栏操作。
- 根据鼠标释放点显示 `FloatingToolbar`（无边框窗口，始终置顶）。
- 实现按钮交互：固定/编辑/取消/保存。
- 按钮与键盘快捷键（Esc/Enter）联动。
- 确保任意操作后关闭蒙版、隐藏工具栏。
- **交付**：工具栏 UI 与按钮事件。
- **风险**：工具栏位置可能越界。解决：根据屏幕边界调整位置。

### 里程碑 4：“固定”功能（桌面便笺）
**目标**：将截图固定在桌面。
- 创建 `StickyImageWindow`，无边框、置顶，可拖拽。
- 支持拖拽移动位置（实现 `MouseDown` + `DragMove`）。
- 支持双击关闭，释放资源。
- 管理多个便笺窗口（List）。
- **交付**：可固定任意数量截图，双击关闭。
- **风险**：窗口焦点影响。解决：窗口属性设置 `AllowsTransparency`、`Topmost` 及 `ShowInTaskbar=False`。

### 里程碑 5：“编辑”功能（调用画图）
**目标**：在系统画图中打开选区图片。
- 将截图保存为临时文件（`Path.GetTempFileName` + `.png`）。
- 启动 `mspaint.exe <tempFile>`，并在编辑结束后清理文件（后台监控进程退出）。
- **交付**：点击编辑后打开画图，加载图片。
- **风险**：用户机器缺少 mspaint。解决：捕获异常并提示。

### 里程碑 6：“保存”与剪贴板逻辑
**目标**：实现保存与剪贴板复制。
- 将最新截图保存在内存（`BitmapSource` 缓存）。
- 监听系统剪贴板快捷键（全局钩子不推荐，可使用托盘菜单触发导出；需求要求 ctrl+c 保存至资源管理器/桌面时写入文件，考虑实现剪贴板监控或注册 `Copy` 命令）。
- **方案建议**：
  1. 截图后将图像对象写入自定义剪贴板格式。
  2. 在托盘应用内监听全局 `KeyDown`（需要低级键盘钩子）以判断资源管理器或桌面窗口激活时 `Ctrl+C`。实现复杂。
  3. **替代实现**：添加托盘菜单“保存到文件”按钮。若必须实现原需求，则：
     - 注册低级键盘钩子捕获 Ctrl+C。
     - 判断当前前台窗口是否资源管理器或桌面（`GetForegroundWindow` + `GetClassName`）。
     - 在捕获到 Ctrl+C 后，在对应目录保存文件（对于桌面使用 `Environment.SpecialFolder.Desktop`，资源管理器读取当前路径需 Shell API）。
- 保存文件命名：`screenshot-{yyyyMMddHHmmss}.png`。
- **交付**：能够在指定场景下将图像写入文件。
- **风险**：钩子权限、安全软件拦截。需添加设置项允许用户禁用自动保存，或 fallback 托盘按钮。

### 里程碑 7：质量保证与发布
**目标**：完成测试与文档。
- 单元测试（对服务层非 UI 部分）。
- 手动测试清单：多显示器、Esc/Enter 快捷键、画图打开、固定便笺、文件保存路径等。
- 编写用户指南（截图、固定、编辑、保存步骤）。
- 打包：使用 `dotnet publish -c Release -r win-x64 --self-contained false`。
- 提供安装说明（可选使用 MSIX 或 zip）。

## 开发排期估算
- 里程碑 1：1 天
- 里程碑 2：2 天
- 里程碑 3：1.5 天
- 里程碑 4：1 天
- 里程碑 5：0.5 天
- 里程碑 6：2 天（视剪贴板方案复杂度调整）
- 里程碑 7：1 天
- **总计**：约 9 天

## 测试计划
- **功能测试**：
  - 热键触发蒙版、Esc 取消。
  - 不同 DPI、多显示器下选区准确性。
  - 工具栏按钮响应（固定/编辑/取消/保存）。
  - 固定便笺拖拽、双击关闭。
  - 画图打开并编辑。
  - Ctrl+C 文件保存路径与命名。
- **性能测试**：截取大屏幕时的响应速度。
- **稳定性**：长时间后台驻留，内存泄漏检查（使用 `dotMemory` 或 `PerfView`）。

## 风险与对策
- **系统权限**：注册全局热键、键盘钩子需管理员权限。对策：在 README 提醒，并尝试使用不需要管理员的 API。
- **安全软件拦截**：签名和说明。
- **多显示器兼容**：使用虚拟屏幕坐标系统测试。
- **剪贴板保存逻辑复杂**：设计可配置开关，允许只使用托盘菜单保存。

## 交付物
- WPF 应用源代码、解决方案文件。
- 发布包（zip 或安装程序）。
- 用户说明文档与测试报告。

## 后续扩展（可选）
- 支持标注工具（箭头、文字）。
- 支持历史截图列表。
- 自定义快捷键与输出目录。
- 自动上传云端或复制到剪贴板。
